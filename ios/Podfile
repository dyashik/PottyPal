# Setup Mapbox authentication FIRST - before any requires or downloads
token = ENV['MAPBOX_DOWNLOADS_TOKEN']
if token && !token.empty?
  netrc_path = File.expand_path("~/.netrc")
  File.open(netrc_path, 'w') do |file|
    file.puts "machine api.mapbox.com"
    file.puts "login mapbox"
    file.puts "password #{token}"
  end
  File.chmod(0600, netrc_path)
  puts "‚úÖ Created .netrc for Mapbox authentication"
else
  puts "‚ö†Ô∏è  Warning: MAPBOX_DOWNLOADS_TOKEN not set - Mapbox downloads may fail"
end

require File.join(File.dirname(`node --print "require.resolve('expo/package.json')"`), "scripts/autolinking")
require File.join(File.dirname(`node --print "require.resolve('react-native/package.json')"`), "scripts/react_native_pods")

require 'json'
podfile_properties = JSON.parse(File.read(File.join(__dir__, 'Podfile.properties.json'))) rescue {}

# Mapbox Navigation setup
$RNMBNAV = Object.new
def $RNMBNAV.pre_install(installer)
  # Mapbox pre-install setup (netrc is already created at top of file)
end
def $RNMBNAV.post_install(installer)
  # Mapbox post-install setup
end

ENV['RCT_NEW_ARCH_ENABLED'] = '0' if podfile_properties['newArchEnabled'] == 'false'
ENV['EX_DEV_CLIENT_NETWORK_INSPECTOR'] = podfile_properties['EX_DEV_CLIENT_NETWORK_INSPECTOR']

platform :ios, podfile_properties['ios.deploymentTarget'] || '15.1'
install! 'cocoapods',
  :deterministic_uuids => false

prepare_react_native_project!

pre_install do |installer|
  $RNMBNAV.pre_install(installer)
end

target 'PottyPal' do
  use_expo_modules!

  if ENV['EXPO_USE_COMMUNITY_AUTOLINKING'] == '1'
    config_command = ['node', '-e', "process.argv=['', '', 'config'];require('@react-native-community/cli').run()"];
  else
    config_command = [
      'npx',
      'expo-modules-autolinking',
      'react-native-config',
      '--json',
      '--platform',
      'ios'
    ]
  end

# @generated begin react-native-maps - expo prebuild (DO NOT MODIFY) sync-e9cc66c360abe50bc66d89fffb3c55b034d7d369
  pod 'react-native-google-maps', path: File.dirname(`node --print "require.resolve('react-native-maps/package.json')"`)
# @generated end react-native-maps
  
  # Mapbox Navigation
  pod 'react-native-mapbox-navigation', :path => '../node_modules/@pawan-pk/react-native-mapbox-navigation'
  
  config = use_native_modules!(config_command)

  use_frameworks! :linkage => podfile_properties['ios.useFrameworks'].to_sym if podfile_properties['ios.useFrameworks']
  use_frameworks! :linkage => ENV['USE_FRAMEWORKS'].to_sym if ENV['USE_FRAMEWORKS']

  use_react_native!(
    :path => config[:reactNativePath],
    :hermes_enabled => podfile_properties['expo.jsEngine'] == nil || podfile_properties['expo.jsEngine'] == 'hermes',
    # An absolute path to your application root.
    :app_path => "#{Pod::Config.instance.installation_root}/..",
    # CRITICAL: Disable privacy manifest aggregation to prevent duplicate PrivacyInfo.xcprivacy
    :privacy_file_aggregation_enabled => false,
  )

  post_install do |installer|
    $RNMBNAV.post_install(installer)
    
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false,
      :ccache_enabled => podfile_properties['apple.ccacheEnabled'] == 'true',
    )
    
    # CRITICAL FIX: Remove ALL PrivacyInfo.xcprivacy from Pods resources script
    # This prevents Pods from copying their PrivacyInfo files to the app bundle
    begin
      resources_script = File.join(installer.sandbox.root, 'Target Support Files/Pods-PottyPal/Pods-PottyPal-resources.sh')
      if File.exist?(resources_script)
        contents = File.read(resources_script)
        privacy_lines = contents.lines.select { |line| line.include?('PrivacyInfo.xcprivacy') }
        
        if privacy_lines.count > 0
          puts "\nüîß Found #{privacy_lines.count} Pod PrivacyInfo references in resources script"
          new_contents = contents.lines.reject { |line| line.include?('PrivacyInfo.xcprivacy') }.join
          File.write(resources_script, new_contents)
          puts "‚úÖ Removed all Pod PrivacyInfo.xcprivacy from copy script"
          puts "   (Your app's PrivacyInfo.xcprivacy in PottyPal/ will still be included)\n"
        end
      end
    rescue => e
      puts "‚ö†Ô∏è  Warning: Could not fix Pods resources script: #{e}"
    end
    
    # ADDITIONAL FIX: Disable privacy manifest aggregation to prevent duplicates
    # This tells Xcode to NOT merge privacy manifests from dependencies
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['GENERATE_INFOPLIST_FILE'] = 'YES'
        # Disable privacy file aggregation for pod targets
        config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
      end
    end
    
    # Set the main app target to disable privacy manifest aggregation
    begin
      project_path = File.join(File.dirname(__FILE__), 'PottyPal.xcodeproj')
      if File.exist?(project_path)
        require 'xcodeproj'
        app_project = Xcodeproj::Project.open(project_path)
        
        app_project.targets.each do |target|
          if target.name == 'PottyPal'
            target.build_configurations.each do |config|
              # Disable automatic privacy manifest aggregation
              config.build_settings['APPLY_RULES_IN_COPY_FILES'] = 'NO'
              config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64' if config.name == 'Debug'
            end
            puts "‚úÖ Updated build settings for #{target.name}"
          end
        end
        
        app_project.save
      end
    rescue => e
      puts "‚ö†Ô∏è  Could not update app build settings: #{e}"
    end

    # --- Mapbox shim file fix ---
    installer.pods_project.targets.each do |target|
      next unless target.respond_to?(:source_build_phase)

      # Remove duplicate Mapbox view manager compile sources
      begin
        compile_phase = target.source_build_phase
        seen = {}
        compile_phase.files.each do |file|
          path = file.file_ref&.path
          next unless path
          if path.include?('MapboxNavigationViewManager.m') || path.include?('MapboxNavigationViewExport.m')
            if seen[path]
              compile_phase.remove_file_reference(file)
            else
              seen[path] = true
            end
          end
        end
      rescue => e
        puts "Mapbox compile-phase cleanup skipped for #{target.name}: #{e}"
      end

      # Ensure RN Mapbox shim file is included
      begin
        shim_rel = "../node_modules/@pawan-pk/react-native-mapbox-navigation/ios/RNMapboxNavigationViewExport.m"
        shim_full = File.join(installer.sandbox.root, "..", shim_rel)
        if File.exist?(shim_full)
          unless target.source_build_phase.files.find { |f| f.file_ref&.path&.end_with?('RNMapboxNavigationViewExport.m') }
            file_ref = target.project.new_file(shim_full)
            target.source_build_phase.add_file_reference(file_ref)
          end
        end
      rescue => e
        puts "Mapbox shim injection skipped for #{target.name}: #{e}"
      end
    end

    # Fix for resource bundles (Xcode 14+)
    installer.target_installation_results.pod_target_installation_results
      .each do |pod_name, target_installation_result|
      target_installation_result.resource_bundle_targets.each do |resource_bundle_target|
        resource_bundle_target.build_configurations.each do |config|
          config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
        end
      end
    end
    
    # CRITICAL FIX: Remove CFBundleExecutable from boost_privacy resource bundle
    # App Store validation fails if resource bundles have CFBundleExecutable but no executable
    begin
      puts "\nüîß Fixing boost_privacy.bundle Info.plist..."
      
      # Fix the boost privacy bundle template that gets copied during build
      boost_privacy_plist = File.join(installer.sandbox.root, 'Target Support Files/boost/ResourceBundle-boost_privacy-boost-Info.plist')
      
      if File.exist?(boost_privacy_plist)
        # Remove CFBundleExecutable if it exists
        system("/usr/libexec/PlistBuddy -c 'Delete :CFBundleExecutable' '#{boost_privacy_plist}' 2>/dev/null")
        
        # Ensure CFBundlePackageType is BNDL
        system("/usr/libexec/PlistBuddy -c 'Set :CFBundlePackageType BNDL' '#{boost_privacy_plist}' 2>/dev/null")
        
        puts "  ‚úÖ Fixed boost_privacy bundle Info.plist template"
      end
      
      # Also add a build phase script to fix any .bundle files in the built app
      installer.pods_project.targets.each do |target|
        if target.name == 'Pods-PottyPal'
          # Add a script phase to remove CFBundleExecutable from all bundles at build time
          script_phase = target.new_shell_script_build_phase('Fix Resource Bundle Info.plist')
          script_phase.shell_script = <<~SCRIPT
            # Remove CFBundleExecutable from all resource bundles
            find "${TARGET_BUILD_DIR}/${UNLOCALIZED_RESOURCES_FOLDER_PATH}" -name "*.bundle" -type d | while read bundle; do
              plist="${bundle}/Info.plist"
              if [ -f "${plist}" ]; then
                /usr/libexec/PlistBuddy -c "Delete :CFBundleExecutable" "${plist}" 2>/dev/null || true
                /usr/libexec/PlistBuddy -c "Set :CFBundlePackageType BNDL" "${plist}" 2>/dev/null || true
              fi
            done
          SCRIPT
          
          puts "  ‚úÖ Added build phase to fix bundle Info.plist files at build time"
          break
        end
      end
      
      puts "‚úÖ Resource bundle fixes applied\n"
    rescue => e
      puts "‚ö†Ô∏è  Warning: Could not fix resource bundles: #{e}"
    end
    
    # Save changes to the pods project
    installer.pods_project.save
  end
end
